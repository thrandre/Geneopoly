<html>
	<head>
		<script src="js/lib/jquery.js"></script>
		<script src="js/lib/three.js"></script>
		<script src="js/lib/tween.js"></script>
		<script src="js/lib/three.collada.js"></script>
		<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,600' rel='stylesheet' type='text/css' />
		<style>
			* {
				margin: 0;
				padding: 0;
			}
			
			body {
				overflow: hidden;
			}
		</style>
	</head>
	<body>
		<script>
			var Utils = {
				toScreenCoordinates	: function ( position ) {
					var widthHalf = $(window).width() / 2;
					var heightHalf = $(window).height() / 2;
					var projector = new THREE.Projector();
					var vector = projector.projectVector( position, Camera );
					
					vector.x = ( vector.x * widthHalf ) + widthHalf;
					vector.y = - ( vector.y * heightHalf ) + heightHalf;
					
					return vector;
				},
				
				clickedObjects : function( e ) {
					var projector = new THREE.Projector();
					
					var vector = new THREE.Vector3( (e.clientX / window.innerWidth) * 2 - 1,  -(e.clientY / window.innerHeight) * 2 + 1, 0.5 );
					projector.unprojectVector( vector, Camera);
					
					var ray = new THREE.Raycaster( Camera.position, vector.subSelf( Camera.position ).normalize() );
					var intersects = ray.intersectObjects( $.map(Objects, function(val, key) { return val; }), true );
					
					return intersects;
				},
				
				recursivelyEnableShadowForCollada	: function( childrenArray ) {
					if( childrenArray.length > 0 ) {
						for( var i in childrenArray ) {
							if( childrenArray[i] instanceof THREE.Mesh ) {
								childrenArray[i].castShadow = true;
							}
							else {
								Utils.recursivelyEnableShadowForCollada(childrenArray[i].children);
							}
						}
					}
				}
			};
			
			var Camera, Scene, Renderer, El, CssOverlay, PlayerDetails, CameraController;
			var GameLock, LetsRoll;
			
			var Objects 		= {};
			var Textures 		= {};
			var Materials 		= {
				transparent	: new THREE.MeshBasicMaterial({ 
					color: 0xffffff, 
					transparent: true, 
					opacity: 0 
				}),
				whitePhong	: new THREE.MeshPhongMaterial({
					color: 0xFFFFFF
				}),
				woodLambert	: new THREE.MeshPhongMaterial({
					color: 0xFFFFFF
				})
			};
			var Models 			= {};
			var Light 			= {};
			var CameraStates 	= {
				start: {
					position	: { x: -250, 		y: -50, 		z: 800 			},
					rotation	: { x: 0, 			y: 0, 			z: Math.PI / 4 	}
				},
				journal: {
					position	: { x: 585, 		y: -350, 		z: 1000 		},
					rotation	: { x: Math.PI / 6,	y: 0, 			z: 0 			}
				},
				boardSide1: {
					position	: { x: -300, 		y: -800, 		z: 1200 		},
					rotation	: { x: Math.PI / 6,	y: 0, 			z: 0 			}
				},
				boardSide2: {
					position	: { x: -1100, 		y: 0, 			z: 1200 		},
					rotation	: { x: 0,			y: -Math.PI / 6,z: -Math.PI / 2	}
				},
				boardSide3: {
					position	: { x: -300, 		y: 800, 		z: 1200 		},
					rotation	: { x: -Math.PI / 6,y: 0,			z: -Math.PI		}
				},
				boardSide4: {
					position	: { x: 500, 		y: 0,	 		z: 1200 		},
					rotation	: { x: 0,			y: Math.PI / 6,	z: -1.5*Math.PI	}
				}
			};
			
			var Game = {
				init: function() {
					Scene = new THREE.Scene();
					
					Camera = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 1000000 );
					$.extend( Camera.position, CameraStates.start.position);
					$.extend( Camera.rotation, CameraStates.start.rotation);
					
					Materials.woodLambert = new THREE.MeshPhongMaterial({
						map: Textures.wood 
					});
					
					Materials.board = new THREE.MeshPhongMaterial({
						map: Textures.board 
					});
					
					Materials.paper = new THREE.MeshPhongMaterial({
						map: Textures.paper 
					});
					
					Materials.card = new THREE.MeshPhongMaterial({
						map: Textures.card
					});
					
					Materials.dice = [];
					for( var i = 0; i < 6; i++ ) {
						Materials.dice[ i ] = new THREE.MeshPhongMaterial({
							map: Textures.dice[ i ]
						});
					}
					
					Objects.worldPlane = new THREE.Mesh( 
						new THREE.PlaneGeometry(100000, 100000, 1, 1),
						Materials.whitePhong
					);
				
					Objects.worldPlane.receiveShadow = true;
					Objects.worldPlane.castShadow = true;
					
					Objects.table = new THREE.Mesh(
						new THREE.CubeGeometry( 2000, 2000, 200 ), 
						Materials.woodLambert
					);
					
					Objects.table.position.z = 100;
					
					Objects.table.castShadow = true;
					Objects.table.receiveShadow = true;
					
					Objects.gameBoard = new THREE.Mesh(
						new THREE.CubeGeometry( 1000, 1000, 10 ), 
						Materials.board
					);
					
					Objects.gameBoard.position.x = -300;
					Objects.gameBoard.position.z = 205;
					
					Objects.gameBoard.castShadow = true;
					Objects.gameBoard.receiveShadow = true;
					
					Objects.clipBoard = Models.clipBoard;
					Objects.clipBoard.position.x = 350;
					Objects.clipBoard.position.y = -250;
					Objects.clipBoard.position.z = 200;
					
					Objects.clipBoard.rotation.x = Math.PI/2;
					
					Objects.invisiPlane = new THREE.Mesh(
						new THREE.PlaneGeometry( 427, 543, 1, 1 ),
						Materials.whitePhong
					);
					
					Objects.invisiPlane.position.x = 585;
					Objects.invisiPlane.position.y = 140;
					Objects.invisiPlane.position.z = 205;
					
					Objects.dice = new THREE.Mesh(
						new THREE.CubeGeometry( 30, 30, 30, 1, 1, 1 ),
						new THREE.MeshFaceMaterial( Materials.dice )
					);
					
					Objects.dice.position.z = 20;
					Objects.dice.position.y = -112;
					Objects.dice.position.x = 112;
					
					Objects.dice.castShadow = true;
					Objects.dice.receiveShadow = true;
					
					Objects.invisiPlane2 = new THREE.Mesh(
						new THREE.PlaneGeometry( 150, 150, 1, 1 ),
						Materials.transparent
					);
					
					Objects.invisiPlane2.position.x = 112;
					Objects.invisiPlane2.position.y = -112;
					Objects.invisiPlane2.position.z = 5.1;
					
					Objects.invisiPlane2.receiveShadow = true;
					
					for( var z = 0; z < 50; z++ ) {
						var c = new THREE.Mesh(
							new THREE.CubeGeometry( 200, 110, 1 ),
							Materials.card
						);
						c.position.z = 5 + (z / 2);
						c.position.x = -104;
						c.position.y = 104;
						c.rotation.z = ((-1 + (Math.random() * 2)) * (Math.PI / 128)) + Math.PI / 4;
						
						Objects.gameBoard.add( c );
						
						if( z == 49 )
							Objects.topCard = c;
					}
					
					Objects.piece = new THREE.Mesh(
						new THREE.CubeGeometry( 30, 30, 60 ),
						Materials.whitePhong
					);
					
					Objects.piece.position.x = 410;
					Objects.piece.position.y = -420;
					Objects.piece.position.z = 35;
					
					Objects.piece.castShadow = true;
					Objects.piece.receiveShadow = true;
					
					Objects.gameBoard.add( Objects.invisiPlane2 );
					Objects.gameBoard.add( Objects.dice );
					Objects.gameBoard.add( Objects.piece );
					
					Light.mainLight = new THREE.SpotLight(0xFFFFFF, 0.5);

					Light.mainLight.position.z = 3000;
					
					Light.mainLight.castShadow = true;
					Light.mainLight.shadowDarkness = 0.3;
					//Light.mainLight.shadowCameraVisible = true;
					
					Light.helperLight = new THREE.SpotLight(0xFFFFFF, 0.5);
					
					Light.helperLight.position.x = 1000;
					Light.helperLight.position.y = 1000;
					Light.helperLight.position.z = 1000;
					
					Light.helperLight.castShadow = true;
					Light.helperLight.shadowDarkness = 0.3;
					
					Light.helperLight2 = new THREE.SpotLight(0xFFFFFF, 0.5);
					
					Light.helperLight2.position.x = -1000;
					Light.helperLight2.position.y = -1000;
					Light.helperLight2.position.z = 1000;
					
					Light.helperLight2.castShadow = true;
					Light.helperLight2.shadowDarkness = 0.3;
					Light.helperLight2.shadowDarkness = 0.3;
					//Light.helperLight2.shadowCameraVisible = true;
					
					//Camera.lookAt( Objects.gameBoard.position );
					
					Scene.add( Objects.worldPlane );
					Scene.add( Objects.table );
					Scene.add( Objects.gameBoard );
					Scene.add( Objects.clipBoard );
					Scene.add( Objects.invisiPlane );
					Scene.add( Light.mainLight );
					Scene.add( Light.helperLight );
					Scene.add( Light.helperLight2 );
					
					Renderer = new THREE.WebGLRenderer({ antialias: true, precision: "highp" });
					Renderer.setSize( window.innerWidth, window.innerHeight );
					Renderer.shadowMapEnabled = true;
					Renderer.shadowMapSoft = true;
					Renderer.shadowMapType = THREE.PCFShadowMap;
					
					Renderer.shadowCameraFov = 50;
					Renderer.shadowMapWidth = 512;
					Renderer.shadowMapHeight = 512;
					
					El = $( Renderer.domElement );
					$( document.body ).append( El );
					
					CameraController = new CameraControllerScaffolding( Camera, CameraStates );
				},
				showPlayerDetails: function() {
					var screen = Utils.toScreenCoordinates( new THREE.Vector3( -270, -30, 210 ) );
					PlayerDetails.fadeIn( 1000 );
					PlayerDetails.css({
						left	: screen.x - (PlayerDetails.outerWidth( true ) / 2),
						top		: screen.y
					});
					PlayerDetails.find( ".name" ).focus();
					PlayerDetails.find("input[type=button]").click(function() {						
						var sex = $(this).attr("class");
						var name = PlayerDetails.find(".name").val();
						if( name === "") {
							alert( "Vennligst tast inn et navn." );
							return;
						}
						Game.setInitialJournalValues( name, sex );
						PlayerDetails.fadeOut(500, function() {
							CameraController.go( "journal", 1500, function() {
								CameraController.go( "boardSide1", 1500, function() {
									GameLock = false;
									LetsRollController.show();
								});
							}, 10000);
						});
					});
				},
				setInitialJournalValues: function( name, gender ) {
					HealthJournal.name().set( name.toUpperCase() );
					HealthJournal.gender().set( gender );
					HealthJournal.age().set( 0 );
					HealthJournal.balance().set( 20000 );
					HealthJournal.physicalHealth().set( 100 );
					HealthJournal.mentalHealth().set( 100 );
					HealthJournal.changed();
				},
				start: function() {					
					DivMapping.setup( Camera, CssOverlay );
					DivMapping.map( Objects.invisiPlane, CssOverlay.find( ".HealthJournal" ) );
					DivMapping.map( Objects.invisiPlane2, CssOverlay.find( ".lets " ));
					
					GameLock = true;
					
					CssOverlay.css( "opacity", 1 );
					CameraController.go( "start", 500 );
					
					Game.animate();
					
					Game.showPlayerDetails();
				},
				newTurn: function( eyes ) {
					GameLock = true;
					LetsRollController.hide();
					PieceController.move( eyes, function( state ) {
						var cStateName = "boardSide" + state.camera;
						if( cStateName !== CameraController.current() )
							CameraController.go( cStateName, 1000 );
					},
					function( newPosition, passed ) {
						BoardController.hit( newPosition, passed, function() {
							if( HealthJournal.changed() ) {
								window.setTimeout(function() {
									CameraController.go( "journal", 1000, function() {
										CameraController.go ( CameraController.previous(), 1000, function() {
											GameLock = false;
											LetsRollController.show();
										});
									}, 10000);
								}, 1000);
							}
							else {
								GameLock = false;
								LetsRollController.show();
							}
						});
					});
				},
				animate	: function() {
					requestAnimationFrame( Game.animate );
					Renderer.render( Scene, Camera );
					TWEEN.update();
					DivMapping._update();
				}
			};
			
			var onDocumentMouseDown = function( e ) {
				e.preventDefault();
				if( GameLock ) return;
				var intersects = Utils.clickedObjects( e );
				var hitDice = false;
				for( var i in intersects ) {
					var o = intersects[ i ].object;
					
					if( o == Objects.dice ) {
						hitDice = true;
					}
				}
				
				if( hitDice ) {
					DiceController.roll( Game.newTurn );
				}
			};
			
			var Parallel = function( cb ) {
				var _promiseCount = 0;
				var _resolved = 0;
				return {
					promise: function() {
						_promiseCount++;
						return function() {
							_resolved++;
							if( _promiseCount === _resolved ) {
								if( cb ) cb();
							}
						};
					}
				};
			};
			
			var DivMapping = (function() {
				return {
					_camera		: null,
					_fov		: 0,
					_wrapperDiv	: null,
					_cameraDiv	: null,
					_glObjs		: [],
					_divs		: [],
					
					setup: function( camera, wrapper ) {
						this._camera = camera;
						this._wrapperDiv = wrapper;
						this._cameraDiv = wrapper.find( ".camera" );
						
						this._fov = 0.5 / Math.tan(this._camera.fov * Math.PI / 360) * wrapper.height();
						
						this._setWrapperStyle();
						this._setCameraStyle();
					},
					
					map: function( glObj, divObj ) {
						this._glObjs.push( glObj );
						this._divs.push( divObj );
						this._update();
					},
					
					_update: function() {
						this._setWrapperStyle();
						this._setCameraStyle();
						for( var i in this._divs ) {
							var d = this._divs[ i ];
							var g = this._glObjs [ i ];						
							this._setObjectStyle( d, g );
						}
					},
					
					_setWrapperStyle: function() {
						this._wrapperDiv.css({
							"-webkit-perspective"	: this._fov + "px",
							"width"					: this._wrapperDiv.width() + "px",
							"height"				: this._wrapperDiv.height() + "px",
							"position"				: "absolute"
						});
					},
					
					_setCameraStyle: function() {
						this._cameraDiv.css({
							"-webkit-transform"		: "translate3d(0,0," + this._fov + "px)" + 
													  this._getCameraCSSMatrix( this._camera ) + " " +
													  "translate3d(" + ( this._wrapperDiv.width() / 2 ) + "px," + ( this._wrapperDiv.height() / 2 ) + "px, 0)",
							"width"					: this._wrapperDiv.width(),
							"height"				: this._wrapperDiv.height()
						});		
					},
					
					_setObjectStyle: function( div, obj ) {
						div.css({
							"-webkit-transform"		: this._getObjectCSSMatrix( div, obj )
						});
					},
					
					_epsilon: function ( value ) {
						return Math.abs( value ) < 0.000001 ? 0 : value;
					},
					
					_getCameraCSSMatrix: function ( camera ) {
						var elements = camera.matrixWorldInverse.elements;
						return 'matrix3d(' +
							this._epsilon( elements[ 0 ] ) + ',' +
							this._epsilon( - elements[ 1 ] ) + ',' +
							this._epsilon( elements[ 2 ] ) + ',' +
							this._epsilon( elements[ 3 ] ) + ',' +
							this._epsilon( elements[ 4 ] ) + ',' +
							this._epsilon( - elements[ 5 ] ) + ',' +
							this._epsilon( elements[ 6 ] ) + ',' +
							this._epsilon( elements[ 7 ] ) + ',' +
							this._epsilon( elements[ 8 ] ) + ',' +
							this._epsilon( - elements[ 9 ] ) + ',' +
							this._epsilon( elements[ 10 ] ) + ',' +
							this._epsilon( elements[ 11 ] ) + ',' +
							this._epsilon( elements[ 12 ] ) + ',' +
							this._epsilon( - elements[ 13 ] ) + ',' +
							this._epsilon( elements[ 14 ] ) + ',' +
							this._epsilon( elements[ 15 ] ) +
						')';
					},
					
					_getObjectCSSMatrix: function ( div, obj ) {
						var elements = obj.matrixWorld.elements;
						var fx = obj.geometry.width / div.outerWidth();
						var fy = obj.geometry.height / div.outerHeight();
						return 'translate3d(-50%,-50%,0) matrix3d(' +
							this._epsilon( elements[ 0 ] ) + ',' +
							this._epsilon( elements[ 1 ] ) + ',' +
							this._epsilon( elements[ 2 ] ) + ',' +
							this._epsilon( elements[ 3 ] ) + ',' +
							this._epsilon( - elements[ 4 ] ) + ',' +
							this._epsilon( - elements[ 5 ] ) + ',' +
							this._epsilon( - elements[ 6 ] ) + ',' +
							this._epsilon( - elements[ 7 ] ) + ',' +
							this._epsilon( elements[ 8 ] ) + ',' +
							this._epsilon( elements[ 9 ] ) + ',' +
							this._epsilon( elements[ 10 ] ) + ',' +
							this._epsilon( elements[ 11 ] ) + ',' +
							this._epsilon( elements[ 12 ] ) + ',' +
							this._epsilon( elements[ 13 ] ) + ',' +
							this._epsilon( elements[ 14 ] ) + ',' +
							this._epsilon( elements[ 15 ] ) +
						')' + 
						' scale3d(' +
							this._epsilon( fx ) + ',' +
							this._epsilon( fy ) + ',' +
							'1' +
						')';
					}
				};
			})();
			
			var HealthJournal = (function() {
				return {
					_journal			: function() { return $(".HealthJournal"); 				},
					_nameTxt			: function() { return this._journal().find(".name");	},
					_picture			: function() { return this._journal().find(".picture");	},
					_genderTxt			: function() { return this._journal().find(".gender");	},
					_ageTxt				: function() { return this._journal().find(".age");		},
					_balanceTxt			: function() { return this._journal().find(".balance");	},
					_incomeTxt			: function() { return this._journal().find(".income");	},
					_physicalPrg		: function() { return this._journal().find(".physical");},
					_mentalPrg			: function() { return this._journal().find(".mental");	},
					_diseasesBx			: function() { return this._journal().find(".diseases");},
					
					_diseases			: {},
					_dJq				: $("<div class=\"d\"><p class=\"key\">ALS</p><p class=\"val\"><div class=\"progressBar\"><div class=\"perc\">30%</div><div class=\"bar\"></div></div></p></div>"),
					
					_changed: false,
					
					changed: function( c ) {
						var self = this;
						if( typeof( c ) !== "undefined" ) {
							this._changed = c;
							if( c ) {
								self.income().set( ((self.age().get() / 100) * (self.mentalHealth().get() / 100) * (self.physicalHealth().get() / 100) * 1000000) + 20000 );
								if( self.physicalHealth().get() <= 0 ) {
									window.location = "http://thekickback.com/rickroll/rickroll.php";
								}
							}
						}
						else {
							var b = this._changed;
							this._changed = false;
							return b;
						}
					},
					
					name: function( ) {
						var self = this;
						return {
							get: function() {
								return self._nameTxt().text();
							},
							set: function( name ) {
								self.changed( true );
								self._nameTxt().text( name );
							}
						};
					},
					
					picture: function( ) {
						var self = this;
						return {
							set: function( url ) {
								self.changed( true );
								self._picture().attr( "src", url );
							}
						};
					},
					
					gender: function( ) {
						var self = this;
						return {
							get: function() {
								return self._genderTxt().text() === "mann" ? "male" : "female";
							},
							set: function( gender ) {
								self.changed( true );
								self._genderTxt().text( (gender === "male" ? "mann" : "kvinne") );
							}
						};
					},
					
					age: function( ) {
						var self = this;
						return {
							get: function() {
								return parseInt( self._ageTxt().text() );
							},
							set: function( age ) {
								self.changed( true );
								self._ageTxt().text( age );
							}
						};
					},
					
					balance: function( ) {
						var self = this;
						return {
							get: function() {
								return parseInt( self._balanceTxt().text() );
							},
							set: function( balance ) {
								self.changed( true );
								self._balanceTxt().text( balance );
							}
						};
					},
					
					income: function( ) {
						var self = this;
						return {
							get: function() {
								return parseInt( self._incomeTxt().text() );
							},
							set: function( income ) {
								self._incomeTxt().text( income );
							}
						};
					},
					
					physicalHealth: function( ) {
						var self = this;
						return {
							get: function() {
								return parseInt( self._physicalPrg().find( ".perc" ).text().replace( "%", "" ) );
							},
							set: function( h ) {
								if( h > 100 ) h = 100;
								if( h < 0 ) h = 0;
								self.changed( true );
								self._physicalPrg().find( ".bar" ).css( "width", h + "%" );
								self._physicalPrg().find( ".perc" ).text( h + "%" );
								self._updatePicture( h, self.mentalHealth().get() );
							}
						};
					},
					
					mentalHealth: function( ) {
						var self = this;
						return {
							get: function() {
								return parseInt( self._mentalPrg().find( ".perc" ).text().replace( "%", "" ) );
							},
							set: function( h ) {
								if( h > 100 ) h = 100;
								if( h < 0 ) h = 0;
								self.changed( true );
								self._mentalPrg().find( ".bar" ).css( "width", h + "%" );
								self._mentalPrg().find( ".perc" ).text( h + "%" );
								self._updatePicture( self.physicalHealth().get(), h );
							}
						};
					},
					
					_updatePicture: function( p, m ) {
						var self = this;
						var state = ( p + m ) > 100 ? "good" : "bad";
						var gender = this.gender().get();
						if( this.name().get().toLowerCase().indexOf("chuck") != -1 ) {
							this.picture().set( "img/chuck.jpg" );
						}
						else if( this.name().get().toLowerCase().indexOf("eivind") != -1 ) {
							this.picture().set( "img/eivind.jpg" );
						}
						else {
							this.picture().set( "img/" + gender + "_" + state + ".jpg" );
						}
						self.changed( true );
					},
					
					risks: function() {
						var self = this;
						return {
							get: function( d ) {
								return parseInt( self._diseases[ d ].find( ".perc" ).text().replace( "%", "" ) )
							},
							set: function( d, p ) {
								if( !self._diseases[ d ] ) {
									self._diseases[ d ] = self._dJq.clone();
									self._diseases[ d ].find( ".key" ).text( d );
									self._diseasesBx().append( self._diseases[ d ] );
								}
								self._diseases[ d ].find( ".bar" ).css( "width", p + "%" );
								self._diseases[ d ].find( ".perc" ).text( p + "%" );
								self.changed( true );
							}
						};
					}
				};
			})();
			
			var CameraControllerScaffolding = function( camera, states ) {
				
				var aCurrentState;
				var currentState;
				var prevState;
				var aPrevState;
				
				return {
					getOptimalBeta: function( alpha, beta ) {
						var d0 	= beta - alpha;
						var d1 	= (-2 * Math.PI + beta) - alpha;						
						return Math.abs( d0 ) > Math.abs( d1 ) ? (alpha + d1) : (alpha + d0);
					},
					getRotationVector: function( aVec, bVec ) {
						var vec = { x: 0, y: 0, z: 0 };
						for( var k in vec ) vec[ k ] = this.getOptimalBeta( aVec[ k ], bVec[ k ] );
						return vec;
					},
					normalize: function( vec ) {
						vec.x = vec.x % (2*Math.PI);
						vec.y = vec.y % (2*Math.PI);
						vec.z = vec.z % (2*Math.PI);
					},
					current: function() {
						return aCurrentState;
					},
					previous: function() {
						return aPrevState;
					},
					rotation: function() {
						return states[ aCurrentState ].rotation;
					},
					go: function( state, duration, cb, hold ) {
						var self = this;
						var p = new Parallel(function() {
							aPrevState = currentState;
							aCurrentState = state;
							prevState = currentState;
							currentState = state;
							
							self.normalize( camera.rotation );
							
							if( cb ) {
								if( hold > 0 ) {
									window.setTimeout( cb, hold );
								}
								else {
									cb();
								}
							}
						});
						
						aPrevState = currentState;
						aCurrentState = state;
						
						var p0 = p.promise();
						var p1 = p.promise();
						
						new TWEEN.Tween( camera.position )
							.to(states[ state ][ "position" ], duration)
							.easing( TWEEN.Easing.Cubic.InOut )
							.onComplete( p0 )
							.start();
						
						var rot = this.getRotationVector( camera.rotation, states[ state ][ "rotation" ] );
						new TWEEN.Tween( camera.rotation )
							.to(rot, duration)
							.easing( TWEEN.Easing.Cubic.InOut )
							.onComplete( p1 )
							.start();
					}
				};
			};
			
			var DiceController = (function() {
				var faces = [
					{ x: 0, 			y: -Math.PI/2, 	z: 0 	},
					{ x: 0, 			y: Math.PI/2, 	z: 0 	},
					{ x: Math.PI/2, 	y: 0, 			z: 0 	},
					{ x: 1.5*Math.PI,	y: 0, 			z: 0 	},
					{ x: 0,				y: 0, 			z: 0 	},
					{ x: Math.PI,		y: 0, 			z: 0 	}
				];
				
				return {
					animate: function( rand, cb ) {
						new TWEEN.Tween( Objects.dice.position )
							.to({ z: 500 }, 250)
							.easing( TWEEN.Easing.Cubic.InOut )
							.chain(
								new TWEEN.Tween( Objects.dice.rotation )
									.to( faces[ rand ], 250)
									.easing( TWEEN.Easing.Cubic.InOut ),
								new TWEEN.Tween( Objects.dice.position )
									.to({ z: 20 }, 250)
									.easing( TWEEN.Easing.Cubic.InOut )
									.onComplete( function() { if( cb ) cb( (rand + 1) ); } )
							)
							.start();
					},
					roll: function( cb ) {
						var rand = Math.floor( (Math.random() * 5.99) );
						this.animate( rand, cb );
					}
				};
			})();
			
			var PieceController = (function() {
				var currentPosition = 1;
				
				var getMeasures = function( frame ) {
					frame = ( frame % 24 === 0 ) ? 24 : frame % 24;
					var side = ( frame % 6 === 0 ) ? Math.floor( frame / 6 ) : Math.floor( frame / 6 ) + 1;
					var relPosition = (frame % 6 === 0) ? 6 : frame % 6;
					return { side: side, rel: relPosition };
				};
				
				var evalFrame = function( frame ) {
					var moveSize, axis, direction;
					var t = getMeasures( frame );
					var n = getMeasures( frame + 1 );
					
					if( t.rel === 1 || n.rel === 1 ) moveSize = 150;
					else moveSize = 130;
					
					if( t.side === 1 ) { axis = 0; 	direction = -1; 	}
					if( t.side === 2 ) { axis = 1; 	direction = 1; 		}
					if( t.side === 3 ) { axis = 0; 	direction = 1; 		}
					if( t.side === 4 ) { axis = 1; 	direction = -1;		}
					
					return { axis: axis, direction: direction, size: moveSize, camera: n.side };
				};
				
				var generateChain = function( obj, frame, steps, stepCb, doneCb ) {
					var movesDone = 0;
					
					var moveDone = function( p ) {
						movesDone++;
						
						if( stepCb )
							stepCb( p );
						
						if( movesDone === steps ) {
							if( doneCb ) {
								var f = ((frame + steps) % 24 === 0) ? 24 : (frame + steps) % 24;
								var passed = (frame + steps) > 24;
								doneCb( f, passed );
							}
						}
						else {
							var f = frame + movesDone;
							move( f,  obj ).start();
						}
					};
					
					var move = function( f, obj ) {
						var p = evalFrame( f );
						var vec = { z: obj.position.z };
						if( p.axis === 0 ) {
							vec.x = obj.position.x + ( p.direction * p.size );
							vec.y = obj.position.y;
						}
						if( p.axis === 1 ) {
							vec.y = obj.position.y + ( p.direction * p.size );
							vec.x = obj.position.x;
						}
						
						return new TWEEN.Tween( obj.position )
							.to( vec, 500 )
							.easing( TWEEN.Easing.Cubic.InOut )
							.onComplete( function() { moveDone( p ); } );
					};
					
					return move( frame, obj );
				};
				
				return {
					move: function( steps, stepCb, doneCb ) {
						var chain = generateChain( Objects.piece, currentPosition, steps, stepCb, function( newPosition, passed ) {
							currentPosition = newPosition;
							doneCb( newPosition, passed );
						});
						
						chain.start();
					}
				};
			})();
			
			var LetsRollController = {
				show: function() {
					Objects.invisiPlane2.rotation.z = CameraController.rotation().z;
					LetsRoll.fadeIn( 500 );
				},
				hide: function() {
					LetsRoll.fadeOut( 500 );
				}
			};
			
			var RiskController = (function() {
				
				var risks = {
					influenza		: { risk: 0, phImpact: 10, mhImpact: 10 },
					heartAttack		: { risk: 0, phImpact: 50, mhImpact: 50 },
					stroke			: { risk: 0, phImpact: 50, mhImpact: 50 },
					breastCancer	: { risk: 0, phImpact: 40, mhImpact: 50 },
					cysticFibrosis	: { risk: 0, phImpact: 30, mhImpact: 20 },
					lplu			: { risk: 0, phImpact: 20, mhImpact: 20 }
				};
				
				return {
					generate: function() {
						var sum = 0;
						for( var k in risks ) {
							if( k !== "influenza" ) {
								var r = Math.random() * 0.2;
								risks[ k ].lower = sum;
								sum = sum + r;
								risks[ k ].risk = r;
								risks[ k ].upper = sum;
							}
						}
						risks[ "influenza" ].risk = 1 - sum;
						risks[ "influenza" ].lower = sum;
						risks[ "influenza" ].upper = 1;
					},
					get: function() {
						return risks;
					},
					getRandom: function() {
						var a = Math.random();
						var sickness;
						for( var s in risks ) {
							if( a >= risks[ s ].lower && a < risks[ s ].upper ) {
								return { sickness: s, risk: risks[ s ].risk, phImpact: risks[ s ].phImpact, mhImpact: risks[ s ].mhImpact };
							}
						}
						
						return { sickness: "influenza", risk: risks[ "influenza" ].risk, phImpact: risks[ "influenza" ].phImpact, mhImpact: risks[ "influenza" ].mhImpact }
					}
				};
			})();
			
			var BoardStates = [
				{ // 1 
					type: "start"
				},
				{ // 2
					type: "free" 
				},
				{ // 3
					type: "free" 
				},
				{ // 4
					type: "free" 
				},
				{ // 5
					type: "sickness" 
				},
				{ // 6
					type: "exercise" 
				},
				{ // 7
					type: "seq" 
				},
				{ // 8
					type: "free" 
				},
				{ // 9
					type: "free" 
				},
				{ // 10
					type: "free" 
				},
				{ // 11
					type: "sickness" 
				},
				{ // 12
					type: "exercise" 
				},
				{ // 13
					type: "seq" 
				},
				{ // 14
					type: "free" 
				},
				{ // 15
					type: "free" 
				},
				{ // 16
					type: "free" 
				},
				{ // 17
					type: "sickness" 
				},
				{ // 18
					type: "exercise" 
				},
				{ // 19
					type: "seq" 
				},
				{ // 20
					type: "free" 
				},
				{ // 21
					type: "free" 
				},
				{ // 22
					type: "free" 
				},
				{ // 23
					type: "sickness" 
				},
				{ // 24
					type: "exercise" 
				}
			];
			
			var BoardController = (function() {
				RiskController.generate();
				
				return {
					hit: function( frame, passed, doneCb ) {
						console.log( HealthJournal.physicalHealth().get() );
						if( passed ) {
							HealthJournal.balance().set( HealthJournal.balance().get() + HealthJournal.income().get() );
							HealthJournal.age().set( HealthJournal.age().get() + 4 );
						}
						
						var state = BoardStates[ frame-1 ];
						if( state.type === "seq" ) {
							var risks = RiskController.get();
							
							HealthJournal.risks().set( r.sickness, Math.round(r.risk * 100) );
							if( r.risk > 0.05 ) {
								HealthJournal.mentalHealth().set( HealthJournal.mentalHealth().get() - 10 );
							}
							
							HealthJournal.balance().set( HealthJournal.balance().get() - 10000 );
						}
						else if( state.type === "sickness" ) {
							var r = RiskController.getRandom();
							console.log( r );
							HealthJournal.physicalHealth().set( HealthJournal.physicalHealth().get() - r.phImpact );
							HealthJournal.mentalHealth().set( HealthJournal.mentalHealth().get() - r.mhImpact );
						}
						else if( state.type === "exercise" ) {
							HealthJournal.physicalHealth().set( HealthJournal.physicalHealth().get() + 20 );
							HealthJournal.mentalHealth().set( HealthJournal.mentalHealth().get() + 20 );
							HealthJournal.balance().set( HealthJournal.balance().get() - 5000 );
						}
						
						doneCb();
					}
				};
			})();
			
			var CardController = (function() {
				return {
					draw: function() {
						
					}
				};
			})();
			
			$(function() {
				var p = new Parallel(function() {
					Game.init();
					Game.start();
				});
				
				var p0 = p.promise();
				var p1 = p.promise();
				var p3 = p.promise();
				var p4 = p.promise();
				
				CssOverlay = $( "#wrapper" );
				CssOverlay.css({
					width	: $(window).width(),
					height	: $(window).height(),
					opacity	: 0
				});
				
				PlayerDetails = $( "#playerDetails" );
				PlayerDetails.hide();
				
				LetsRoll = $( ".lets" );
				LetsRoll.fadeOut( 0 );
				
				Textures.wood = THREE.ImageUtils.loadTexture("tex/teak.jpg", {}, p0);
				Textures.wood.wrapS = THREE.RepeatWrapping;
				Textures.wood.wrapT = THREE.RepeatWrapping;
				Textures.wood.repeat.set(10, 10);
				Textures.wood.needsUpdate = true;
				
				Textures.board = THREE.ImageUtils.loadTexture("tex/board.png", {}, p1);
				Textures.board.wrapS = THREE.RepeatWrapping;
				Textures.board.wrapT = THREE.RepeatWrapping;
				Textures.board.repeat.set(1, 1);
				Textures.board.needsUpdate = true;
				
				Textures.card = THREE.ImageUtils.loadTexture("tex/card.png", {}, p4);
				Textures.card.wrapS = THREE.RepeatWrapping;
				Textures.card.wrapT = THREE.RepeatWrapping;
				Textures.card.repeat.set(1, 1);
				Textures.card.needsUpdate = true;
				
				Textures.dice = [];
				for( var i = 0; i < 6; i++ ) {
					var cb = p.promise();
					Textures.dice[ i ] = THREE.ImageUtils.loadTexture("tex/dice" + (i+1) + ".png", {}, cb);
				}
				
				var loader = new THREE.ColladaLoader();
				loader.options.convertUpAxis = true;
				loader.load("clipboard.dae", function ( collada ) {
					dae = collada.scene;
					dae.scale.x = dae.scale.y = dae.scale.z = 50.0;
					Utils.recursivelyEnableShadowForCollada(dae.children);
					
					Models.clipBoard = dae;
					p3();
				});
				
				$(window).resize(function() {
					Renderer.setSize( $(window).width(), $(window).height() );
					Camera.aspect = $(window).width() / $(window).height();
					Camera.updateProjectionMatrix();
					DivMapping.setup( Camera, CssOverlay );
					if( PlayerDetails.is(":visible") ) {
						Game.showPlayerDetails();
					}
					CssOverlay.css({
						width	: $(window).width(),
						height	: $(window).height()
					});
				});
				
				document.addEventListener( "mousedown", onDocumentMouseDown, false );
			});
		</script>
		<style>
			#playerDetails {
				position: absolute;
				z-index: 200;
				float: left;
				clear: both;
			}
			
			#playerDetails .name {
				text-transform: uppercase;
				font-family: Open Sans;
				font-weight: 300;
				font-size: 16px;
				padding: 5px;
				text-align: center;
				border-radius: 5px;
				margin-bottom: 10px;
			}
			
			#playerDetails input[type=button] {
				text-transform: uppercase;
				font-family: Open Sans;
				font-weight: 300;
				font-size: 16px;
				padding: 5px;
				text-align: center;
				border-radius: 5px;
				background-color: #C60202;
				color: #fff;
			}
			
			#playerDetails p {
				text-align: center;
			}
			
			#playerDetails .sex {
				background: #f00;
				display: block;
			}
			
			#wrapper {
				-webkit-transform-style: preserve-3d; 
				-webkit-perspective-origin: 50% 50%;
			}
			
			html:-webkit-full-screen {}
			
			.camera {
				-webkit-transform-style: preserve-3d;
				-webkit-transform-origin: 50% 50%;
			}
			
			.HealthJournal {
				width: 430px; 
				height: 543px;
				padding: 40px;
				position: absolute; 
				-webkit-transform-style: preserve-3d;
				-webkit-transform-origin: 50% 50%;
				-webkit-backface-visibility: hidden;
				padding-top: 75px;
				clear: both;
			}
			
			.lets {
				width: 150px; 
				height: 150px;
				position: absolute; 
				-webkit-transform-style: preserve-3d;
				-webkit-transform-origin: 50% 50%;
				-webkit-backface-visibility: hidden;
				clear: both;
				background: url(tex/lets.png) no-repeat;
				background-size: cover;
			}
			
			.header {
				float: left;
				clear: both;
				margin-bottom: 20px;
			}
			
			.colorBar {
				height: 80px;
				width: 10px;
				background: #f00;
				margin-right: 20px;
				float: left;
			}
			
			.headerText {
				float: left;
			}
			
			h1 {
				font-family: Open Sans;
				font-weight: 300;
				margin: 0;
			}
			
			h2 {
				font-family: Open Sans;
				font-weight: 600;
				text-transform: uppercase;
				margin: 0;
			}
			
			.picture {
				width: 128px;
				height: 128px;
				float: left;
				margin-right: 20px;
			}
			
			.bio {
				float: left;
				clear: both;
				margin-bottom: 20px;
			}
			
			.bioInfo {
				float: left;
			}
			
			.bioInfo .line {
				float: left;
				clear: both;
			}
			
			.bioInfo .key {
				font-family: Open Sans;
				font-weight: 600;
				float: left;
				width: 100px;
			}
			
			.bioInfo .val {
				font-family: Open Sans;
				font-weight: 300;
				float: left;
			}
			
			.health {
				float: left;
				clear: both;
				margin-bottom: 20px;
			}
			
			.health .line {
				margin-bottom: 10px;
				float: left;
				clear: both;
			}
			
			.health .key {
				font-family: Open Sans;
				font-weight: 600;
				font-size: 20px;
				float: left;
				clear: both;
			}
			
			.health .val {
				font-family: Open Sans;
				font-weight: 300;
				float: left;
				clear: both;
			}
			
			.progressBar {
				width: 427px;
				height: 15px;
				border: 1px solid #333;
				float: left;
				clear: both;
			}
			
			.progressBar .bar {
				width: 10%;
				height: 100%;
				background: #f00;
			}
			
			.progressBar .perc {
				width: 427px;
				text-align: center;
				position: absolute;
				font-family: Open Sans;
				font-weight: 600;
				font-size: 11px;
			}
			
			.risks {
				float: left;
				clear: both;
			}
			
			.risks .key {
				font-family: Open Sans;
				font-weight: 600;
				font-size: 20px;
				float: left;
				clear: both;
			}
			
			.risks .diseases {
				font-family: Open Sans;
				font-weight: 300;
				float: left;
				clear: both;
			}
			
			.risks .d {
				float: left;
				margin-right: 5px;
			}
			
			.risks .d .key {
				font-family: Open Sans;
				font-weight: 600;
				font-size: 12px;
				float: left;
				clear: both;
			}
			
			.risks .d .progressBar {
				width: 100px !important;
			}
			
			.risks .d .progressBar .perc {
				width: 100px !important;
			}
		</style>
		<div id="playerDetails">
			<p>
				<input type="text" value="" class="name" placeholder="navn"/>
			</p>
			<p>
				<span>
					<input type="button" value="Mann" class="male">
					<input type="button" value="Kvinne" class="female">
				</span>
			</p>
		</div>
		<div id="wrapper">
			<div class="camera">
				<div class="object lets">
				</div>
				<div class="object HealthJournal">
					<div class="header">
						<div class="colorBar"></div>
						<div class="headerText">
							<h1>helsejournal</h1>
							<h2 class="name">THOMAS ANDRESEN</h2>
						</div>
					</div>
					<div class="bio">
						<img class="picture" />
						<div class="bioInfo">
							<div class="line">
								<p class="key">KJØNN</p>
								<p class="val gender">mann</p>
							</div>
							<div class="line">
								<p class="key">ALDER</p>
								<p class="val age">25</p>
							</div>
							<div class="line">
								<p class="key">INNTEKT</p>
								<p class="val income">0</p>
							</div>
							<div class="line">
								<p class="key">FORMUE</p>
								<p class="val balance">0</p>
							</div>
						</div>
					</div>
					<div class="health">
						<div class="line">
							<p class="key">FYSISK HELSE</p>
							<p class="val">
								<div class="progressBar physical">
									<div class="perc">10%</div>
									<div class="bar"></div>
								</div>
							</p>
						</div>
						<div class="line">
							<p class="key">MENTAL HELSE</p>
							<p class="val">
								<div class="progressBar mental">
									<div class="perc">10%</div>
									<div class="bar"></div>
								</div>
							</p>
						</div>
					</div>
					<div class="risks">
						<p class="key">KARTLAGTE RISIKOER</p>
						<div class="diseases">
						</p>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>