<html>
	<head>
		<script src="js/lib/jquery.js"></script>
		<script src="js/lib/three.js"></script>
		<script src="js/lib/three.divMapper.js"></script>
		<script src="js/lib/tween.js"></script>
		<script src="js/lib/three.collada.js"></script>
		<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,600' rel='stylesheet' type='text/css' />
		<style>
			* {
				margin: 0;
				padding: 0;
			}
			
			body {
				overflow: hidden;
			}
			
			.playerDetails {
				position: absolute;
				z-index: 200;
				float: left;
				clear: both;
			}
			
			.playerDetails .name {
				text-transform: uppercase;
				font-family: Open Sans;
				font-weight: 300;
				font-size: 16px;
				padding: 5px;
				text-align: center;
				border-radius: 5px;
				margin-bottom: 10px;
			}
			
			.playerDetails input[type=button] {
				text-transform: uppercase;
				font-family: Open Sans;
				font-weight: 300;
				font-size: 16px;
				padding: 5px;
				text-align: center;
				border-radius: 5px;
				background-color: #C60202;
				color: #fff;
			}
			
			.playerDetails p {
				text-align: center;
			}
			
			.playerDetails .sex {
				background: #f00;
				display: block;
			}
			
			.letsRoll {
				width: 150px; 
				height: 150px;
				clear: both;
				background: url(tex/lets.png) no-repeat;
				background-size: cover;
				background-size: cover;
			}
			
			.clipBoard {
				width: 250px; 
				height: 360px;
				padding: 40px;
				position: absolute; 
				padding-top: 75px;
				clear: both;
				background: url(img/clipBoard.png) no-repeat;
				background-size: 100%;
				opacity: 0;
				left: -311px;
			}
			
			.clipboard .healthJournal {
				float: left;
				clear: both;
			}
			
			.clipboard .healthJournal .header {
				float: left;
				clear: both;
				margin-bottom: 20px;
			}
			
			.clipboard .healthJournal .colorBar {
				height: 50px;
				width: 5px;
				background: #f00;
				margin-right: 10px;
				float: left;
			}
			
			.clipboard .healthJournal .headerText {
				float: left;
			}
			
			.clipboard .healthJournal h1 {
				font-family: Open Sans;
				font-weight: 300;
				margin: 0;
				font-size: 20px;
			}
			
			.clipboard .healthJournal h2 {
				font-family: Open Sans;
				font-weight: 600;
				text-transform: uppercase;
				margin: 0;
				font-size: 14px;
			}
			
			.clipboard .healthJournal .picture {
				width: 64px;
				height: 64px;
				float: left;
				margin-right: 20px;
			}
			
			.clipboard .healthJournal .bio {
				float: left;
				clear: both;
				margin-bottom: 10px;
			}
			
			.clipboard .healthJournal .bioInfo {
				float: left;
			}
			
			.bioInfo .line {
				float: left;
				clear: both;
			}
			
			.bioInfo .key {
				font-family: Open Sans;
				font-size: 10px;
				font-weight: 600;
				float: left;
				width: 100px;
			}
			
			.bioInfo .val {
				font-family: Open Sans;
				font-size: 10px;
				font-weight: 300;
				float: left;
			}
			
			.health {
				float: left;
				clear: both;
				margin-bottom: 10px;
			}
			
			.health .line {
				margin-bottom: 10px;
				float: left;
				clear: both;
			}
			
			.health .key {
				font-family: Open Sans;
				font-weight: 600;
				font-size: 12px;
				float: left;
				clear: both;
			}
			
			.health .val {
				font-family: Open Sans;
				font-weight: 300;
				float: left;
				clear: both;
			}
			
			.progressBar {
				width: 250px;
				height: 8px;
				border: 1px solid #333;
				float: left;
				clear: both;
				padding: 0;
			}
			
			.progressBar .bar {
				width: 10%;
				height: 100%;
				background: #f00;
			}
			
			.progressBar .perc {
				width: 250px;
				text-align: center;
				position: absolute;
				font-family: Open Sans;
				font-weight: 600;
				font-size: 8px;
				margin-top: -2px;
			}
			
			.risks {
				float: left;
				clear: both;
			}
			
			.risks .key {
				font-family: Open Sans;
				font-weight: 600;
				font-size: 12px;
				float: left;
				clear: both;
			}
			
			.risks .diseases {
				font-family: Open Sans;
				font-weight: 300;
				float: left;
				clear: both;
			}
			
			.risks .d {
				float: left;
				margin-right: 5px;
			}
			
			.risks .d .key {
				font-family: Open Sans;
				font-weight: 600;
				font-size: 12px;
				float: left;
				clear: both;
			}
			
			.risks .d .progressBar {
				width: 50px !important;
			}
			
			.risks .d .progressBar .perc {
				width: 50px !important;
			}
		</style>
	</head>
	<body>
		<script>
			var Utils = {
				toScreenCoordinates	: function ( position ) {
					var widthHalf = $(window).width() / 2;
					var heightHalf = $(window).height() / 2;
					var projector = new THREE.Projector();
					var vector = projector.projectVector( position, CameraInstance );
					
					vector.x = ( vector.x * widthHalf ) + widthHalf;
					vector.y = - ( vector.y * heightHalf ) + heightHalf;
					
					return vector;
				},
				
				clickedObjects : function( e ) {
					var projector = new THREE.Projector();
					
					var vector = new THREE.Vector3( (e.clientX / window.innerWidth) * 2 - 1,  -(e.clientY / window.innerHeight) * 2 + 1, 0.5 );
					projector.unprojectVector( vector, CameraInstance);
					
					var ray = new THREE.Raycaster( CameraInstance.position, vector.sub( CameraInstance.position ).normalize() );
					var intersects = ray.intersectObjects( $.map(Objects, function(val, key) { return val; }), true );
					
					return intersects;
				},
				
				recursivelyEnableShadowForCollada	: function( childrenArray ) {
					if( childrenArray.length > 0 ) {
						for( var i in childrenArray ) {
							if( childrenArray[i] instanceof THREE.Mesh ) {
								childrenArray[i].castShadow = true;
							}
							else {
								Utils.recursivelyEnableShadowForCollada(childrenArray[i].children);
							}
						}
					}
				}
			};
			
			var CameraInstance, 
				SceneInstance, 
				RendererInstance, 
				CameraControllerInstance,
				PlayerDetailsControllerInstance,
				ClipBoardControllerInstance, 
				LetsRollControllerInstance,
				ClipBoardControllerInstance,
				BoardControllerInstance,
				DivMapperInstance,
				GameLock;
			
			var _AUTOPLAY_ = true;
			
			var Objects 		= {};
			var Textures 		= {};
			var Materials 		= {
				transparent	: new THREE.MeshBasicMaterial({ 
					color		: 0xffffff, 
					transparent	: true, 
					opacity		: 0 
				}),
				whitePhong	: new THREE.MeshPhongMaterial({
					color		: 0xFFFFFF
				}),
				wood	: new THREE.MeshPhongMaterial({
					color		: 0xFFFFFF
				})
			};
			var Models 			= {};
			var Light 			= {};
			var CameraStates 	= {
				start: {
					position	: { x: 50, 			y: -50,			z: 800 			},
					rotation	: { x: 0, 			y: 0, 			z: Math.PI / 4 	}
				},
				boardSide1: {
					position	: { x: 0, 			y: -800, 		z: 1200 		},
					rotation	: { x: Math.PI / 6,	y: 0, 			z: 0 			}
				},
				boardSide2: {
					position	: { x: -800, 		y: 0, 			z: 1200 		},
					rotation	: { x: 0,			y: -Math.PI / 6,z: -Math.PI / 2	}
				},
				boardSide3: {
					position	: { x: 0, 			y: 800, 		z: 1200 		},
					rotation	: { x: -Math.PI / 6,y: 0,			z: -Math.PI		}
				},
				boardSide4: {
					position	: { x: 800, 		y: 0,	 		z: 1200 		},
					rotation	: { x: 0,			y: Math.PI / 6,	z: -1.5*Math.PI	}
				}
			};
			
			var Game = {
				init: function() {
					SceneInstance = new THREE.Scene();
					
					/*** CameraInstance ***/					
					CameraInstance = new THREE.PerspectiveCamera( 35, window.innerWidth / window.innerHeight, 1, 1000000 );
					$.extend( CameraInstance.position, CameraStates.start.position);
					$.extend( CameraInstance.rotation, CameraStates.start.rotation);
					
					/*** MATERIALS ***/
					Materials.wood = new THREE.MeshPhongMaterial({
						map: Textures.wood 
					});
					Materials.board = new THREE.MeshPhongMaterial({
						map: Textures.board 
					});
					Materials.paper = new THREE.MeshPhongMaterial({
						map: Textures.paper 
					});
					Materials.card = new THREE.MeshPhongMaterial({
						map: Textures.card
					});
					Materials.dice = [];
					for( var i = 0; i < 6; i++ ) {
						Materials.dice[ i ] = new THREE.MeshPhongMaterial({
							map: Textures.dice[ i ]
						});
					}
					
					/*** OBJECTS ***/
					/* WORLD PLANE */
					Objects.worldPlane = new THREE.Mesh( 
						new THREE.PlaneGeometry(100000, 100000, 1, 1),
						Materials.whitePhong
					);
					Objects.worldPlane.receiveShadow = true;
					Objects.worldPlane.castShadow = true;
					
					Objects.table = new THREE.Mesh(
						new THREE.CubeGeometry( 2000, 2000, 200 ), 
						Materials.wood
					);
					Objects.table.position.z = 100;
					Objects.table.castShadow = true;
					Objects.table.receiveShadow = true;
					
					/* GAMEBOARD */
					Objects.gameBoard = new THREE.Mesh(
						new THREE.CubeGeometry( 1000, 1000, 10 ), 
						Materials.board
					);
					Objects.gameBoard.position.z = 205;
					Objects.gameBoard.castShadow = true;
					Objects.gameBoard.receiveShadow = true;
					
					/* DICE */
					Objects.dice = new THREE.Mesh(
						new THREE.CubeGeometry( 30, 30, 30, 1, 1, 1 ),
						new THREE.MeshFaceMaterial( Materials.dice )
					);
					Objects.dice.position.z = 20;
					Objects.dice.position.y = -112;
					Objects.dice.position.x = 112;
					Objects.dice.castShadow = true;
					Objects.dice.receiveShadow = true;
					
					/* LETSROLL PLANE */
					Objects.letsRollPlane = new THREE.Mesh(
						new THREE.PlaneGeometry( 150, 150, 1, 1 ),
						Materials.transparent
					);
					Objects.letsRollPlane.position.x = 112;
					Objects.letsRollPlane.position.y = -112;
					Objects.letsRollPlane.position.z = 5.1;
					Objects.letsRollPlane.receiveShadow = true;
					
					/* CARD STACK */
					for( var z = 0; z < 50; z++ ) {
						var c = new THREE.Mesh(
							new THREE.CubeGeometry( 200, 110, 1 ),
							Materials.card
						);
						c.position.z = 5 + (z / 2);
						c.position.x = -104;
						c.position.y = 104;
						c.rotation.z = ((-1 + (Math.random() * 2)) * (Math.PI / 128)) + Math.PI / 4;
						Objects.gameBoard.add( c );
						if( z == 49 )
							Objects.topCard = c;
					}
					
					/* PIECE */
					Objects.piece = new THREE.Mesh(
						new THREE.CubeGeometry( 30, 30, 60 ),
						Materials.whitePhong
					);
					Objects.piece.position.x = 410;
					Objects.piece.position.y = -420;
					Objects.piece.position.z = 35;
					Objects.piece.castShadow = true;
					Objects.piece.receiveShadow = true;
					
					/*** LIGHT ***/
					/* MAIN LIGHT */
					Light.mainLight = new THREE.SpotLight(0xFFFFFF, 0.5);
					Light.mainLight.position.z = 3000;
					Light.mainLight.castShadow = true;
					Light.mainLight.shadowDarkness = 0.3;
					//Light.mainLight.shadowCameraVisible = true;
					
					/* HELPER LIGHT */
					Light.helperLight = new THREE.SpotLight(0xFFFFFF, 0.5);
					Light.helperLight.position.x = 1000;
					Light.helperLight.position.y = 1000;
					Light.helperLight.position.z = 1000;
					Light.helperLight.castShadow = true;
					Light.helperLight.shadowDarkness = 0.3;
					
					/* HELPER LIGHT 2 */
					Light.helperLight2 = new THREE.SpotLight(0xFFFFFF, 0.5);
					Light.helperLight2.position.x = -1000;
					Light.helperLight2.position.y = -1000;
					Light.helperLight2.position.z = 1000;
					Light.helperLight2.castShadow = true;
					Light.helperLight2.shadowDarkness = 0.3;
					Light.helperLight2.shadowDarkness = 0.3;
					//Light.helperLight2.shadowCameraVisible = true;
					
					/*** GAMEBOARD CHILDREN ***/
					Objects.gameBoard.add( Objects.letsRollPlane );
					Objects.gameBoard.add( Objects.dice );
					Objects.gameBoard.add( Objects.piece );
					
					/*** SceneInstance CHILDREN ***/
					SceneInstance.add( Objects.worldPlane );
					SceneInstance.add( Objects.table );
					SceneInstance.add( Objects.gameBoard );
					SceneInstance.add( Objects.clipBoard );
					SceneInstance.add( Objects.invisiPlane );
					SceneInstance.add( Light.mainLight );
					SceneInstance.add( Light.helperLight );
					SceneInstance.add( Light.helperLight2 );
					
					/*** RendererInstance ***/
					RendererInstance = new THREE.WebGLRenderer({ antialias: true, precision: "highp" });
					RendererInstance.setSize( window.innerWidth, window.innerHeight );
					RendererInstance.shadowMapEnabled = true;
					RendererInstance.shadowMapSoft = true;
					RendererInstance.shadowMapType = THREE.PCFShadowMap;
					RendererInstance.shadowCameraFov = 50;
					RendererInstance.shadowMapWidth = 512;
					RendererInstance.shadowMapHeight = 512;
					
					$( document.body ).append( $( RendererInstance.domElement ) );
					
					/*** INITIALIZE CONTROLLERS ***/
					CameraControllerInstance 		= new CameraController( CameraInstance, CameraStates );
					ClipBoardControllerInstance 	= new ClipBoardController( $(window), $( ".clipBoard" ) );
					LetsRollControllerInstance		= new LetsRollController( $( ".letsRoll" ), Objects.letsRollPlane );
					DiceControllerInstance 			= new DiceController( Objects.dice );
					PieceControllerInstance			= new PieceController( Objects.piece );
					RiskControllerInstance			= new RiskController();
					PlayerDetailsControllerInstance	= new PlayerDetailsController( $( ".playerDetails" ), new THREE.Vector3( 30, -30, 210 ) );
					BoardControllerInstance			= new BoardController();
					HealthJournalControllerInstance	= new HealthJournalController( $( ".healthJournal" ) );
				},
				promptPlayerDetails: function() {
					PlayerDetailsControllerInstance.show(function() {
						var el = PlayerDetailsControllerInstance.el();
						el.find( ".name" ).focus();
						el.find( "input[type=button]" ).click(function() {						
							var sex = $(this).attr("class");
							var name = el.find(".name").val();
							if( name === "") {
								alert( "Vennligst tast inn et navn." );
								return;
							}
							Game.setInitialJournalValues( name, sex );
							el.fadeOut(500, function() {
								CameraControllerInstance.go( "boardSide1", 1500, function() {
									ClipBoardControllerInstance.show(function() {
										GameLock = false;
										LetsRollControllerInstance.show( CameraControllerInstance.rotation().z );
									});
								});
							});
						});
					});
				},
				setInitialJournalValues: function( name, gender ) {
					HealthJournalControllerInstance.name( name.toUpperCase() );
					HealthJournalControllerInstance.gender( gender );
					HealthJournalControllerInstance.age( 0 );
					HealthJournalControllerInstance.balance( 20000 );
					HealthJournalControllerInstance.physicalHealth( 100 );
					HealthJournalControllerInstance.mentalHealth( 100 );
					HealthJournalControllerInstance.changed();
				},
				start: function() {					
					DivMapperInstance = new THREE.DivMapper( CameraInstance, $(document.body) );					
					DivMapperInstance.map( $( ".letsRoll" ), Objects.letsRollPlane);
					DivMapperInstance.update();
					
					GameLock = true;
					
					CameraControllerInstance.go( "start", 500 );
					
					Game.animate();
					Game.promptPlayerDetails();
				},
				turnStart: function( eyes ) {
					GameLock = true;
					LetsRollControllerInstance.hide();
					ClipBoardControllerInstance.hide();
					PieceControllerInstance.move( eyes, function( state ) {
						var cStateName = "boardSide" + state.CameraInstance;
						if( cStateName !== CameraControllerInstance.current() )
							CameraControllerInstance.go( cStateName, 1000 );
					},
					function( newPosition, passed ) {
						BoardControllerInstance.hit( newPosition, passed, function() {
							if( HealthJournalControllerInstance.changed() )
								ClipBoardControllerInstance.show();
							GameLock = false;
							LetsRollControllerInstance.show( CameraControllerInstance.rotation().z );
							if( _AUTOPLAY_ )
								window.setTimeout( function() { DiceControllerInstance.roll( Game.turnStart ); }, 2000 );
						});
					});
				},
				animate	: function() {
					requestAnimationFrame( Game.animate );
					RendererInstance.render( SceneInstance, CameraInstance );
					TWEEN.update();
					DivMapperInstance.update();
				}
			};
			
			var onDocumentMouseDown = function( e ) {
				e.preventDefault();
				if( GameLock ) return;
				var intersects = Utils.clickedObjects( e );
				var hitDice = false;
				for( var i in intersects ) {
					var o = intersects[ i ].object;
					
					if( o == Objects.dice ) {
						hitDice = true;
					}
				}
				
				if( hitDice ) {
					DiceControllerInstance.roll( Game.turnStart );
				}
			};
			
			var Parallel = function( cb ) {
				var _promiseCount = 0;
				var _resolved = 0;
				return {
					promise: function() {
						_promiseCount++;
						return function() {
							_resolved++;
							if( _promiseCount === _resolved ) {
								if( cb ) cb();
							}
						};
					}
				};
			};
			
			var HealthJournalController = function( journal ) {
				
				var	elements = {
					name		: journal.find( ".name" ),
					pic			: journal.find( ".picture" ),
					gender		: journal.find( ".gender" ),
					age			: journal.find( ".age" ),
					balance		: journal.find( ".balance" ),
					income		: journal.find( ".income" ),
					physical	: journal.find( ".physical" ),
					mental		: journal.find( ".mental" ),
					diseases	: journal.find( ".diseases" )
				};
				
				var jqRisk = $("<div class=\"d\"><p class=\"key\"></p><p class=\"val\"><div class=\"progressBar\"><div class=\"perc\"></div><div class=\"bar\"></div></div></p></div>");
				
				var risks = {};
				
				var _changed = false;
				var changed = function( c ) {
					if( typeof( c ) === "undefined" ) {
						c = _changed;
						_changed = false;
						return c;
					}
					else {
						update();
						_changed = c;
					}
				};
				
				var update = function() {
					updatePicture();
					income( Math.round( ( ( age() / 100 ) * ( mentalHealth() / 100 ) * ( physicalHealth() / 100 ) * 1000000 ) ) + 20000 );
				};
				
				var get = function( el ) {
					return elements[ el ].text();
				};
				
				var set = function( el, val, silent ) {
					elements[ el ].text( val );
					if( !silent ) changed( true );
				};
				
				var picture = function( url ) {
					elements[ "pic" ].attr( "src", url );
				};
				
				var updatePicture = function() {
					var state = ( physicalHealth() + mentalHealth() ) > 100 ? "good" : "bad";
					if( name().toLowerCase().indexOf("chuck") != -1 ) {
						picture( "img/chuck.jpg" );
					}
					else if( name().toLowerCase().indexOf("eivind") != -1 ) {
						picture( "img/eivind.jpg" );
					}
					else {
						picture( "img/" + gender() + "_" + state + ".jpg" );
					}
				};
				
				var progressBar = function( el, val ) {
					var bar 	= el.find( ".bar" );
					var text 	= el.find( ".perc" );
					if( typeof( val ) !== "undefined" ) {
						val = Math.round( val );
						if( val > 100 ) val = 100;
						if( val < 0 )	val = 0;
						bar.css( "width", val + "%" );
						text.text( val + "%" );
						changed( true );
					}
					else {
						return parseInt( text.text().replace("%", "") );
					}
				};
				
				var name = function( val ) {
					if( typeof( val ) !== "undefined" ) 	set( "name", val );
					else 		return get( "name" );
				};
				
				var gender = function( val ) {
					if( typeof( val ) !== "undefined" )	set( "gender", val === "male" ? "mann" : "kvinne" );
					else		return get( "gender" ) === "mann" ? "male" : "female";
				};
				
				var age = function( val, rel ) {
					if( typeof( val ) !== "undefined" )	set( "age", rel ? ( +get( "age" ) + val ) : val );
					else 		return parseInt( get( "age" ) );
				};
				
				var balance = function( val, rel ) {
					if( typeof( val ) !== "undefined" )	set( "balance", rel ? ( +get( "balance" ) + val ) : Math.round( val ) );
					else 		return parseInt( get( "balance" ) );
				};
				
				var income = function( val ) {
					if( typeof( val ) !== "undefined" )	set( "income", Math.round( val ), true );
					else 		return parseInt( get( "income" ) );
				};
				
				var physicalHealth = function( val, rel ) {
					if( typeof( val ) !== "undefined" )	progressBar( elements[ "physical" ], rel ? ( +progressBar( elements[ "physical" ] ) + val ) : val );
					else 		return progressBar( elements[ "physical" ] );
				};
				
				var mentalHealth = function( val, rel ) {
					if( typeof( val ) !== "undefined" )	progressBar( elements[ "mental" ], rel ? ( +progressBar( elements[ "mental" ] ) + val ) : val );
					else 		return progressBar( elements[ "mental" ] );
				};
				
				var risk = function( d, val ) {
					var key;
					if( typeof( val ) !== "undefined" ) {
						if( !risks[ d ] ) {
							risks[ d ] = jqRisk.clone().appendTo( elements[ "diseases" ] );
							risks[ d ].find( ".key" ).text( d );
						}
						progressBar( risks[ d ].find( ".progressBar" ), val );
					}
					else {
						return risks[ d ] ? progressBar( risks[ d ].find( ".progressBar" ) ) : 0;
					}
				};
				
				var pay = function( val ) {
					if( balance() < val ) {
						return false;
					}
					else {
						balance( -val, true );
						return true;
					}
				};
				
				var birthday = function() {
					age( 4, true );
					balance( income(), true );
				};
				
				return {
					name			: name,
					gender			: gender,
					age				: age,
					balance			: balance,
					income			: income,
					physicalHealth	: physicalHealth,
					mentalHealth	: mentalHealth,
					risk			: risk,
					pay				: pay,
					birthday		: birthday,
					changed			: changed
				};
				
			};
			
			var CameraController = function( camera, states ) {
				
				var aCurrentState;
				var currentState;
				var prevState;
				var aPrevState;
				
				var getOptimalBeta = function( alpha, beta ) {
					var d0 	= beta - alpha;
					var d1 	= (-2 * Math.PI + beta) - alpha;						
					return Math.abs( d0 ) > Math.abs( d1 ) ? (alpha + d1) : (alpha + d0);
				};
				
				var getRotationVector = function( a, b ) {
					var vec = { x: 0, y: 0, z: 0 };
					for( var k in vec ) vec[ k ] = getOptimalBeta( a[ k ], b[ k ] );
					return vec;
				};
				
				var normalize = function( vec ) {
					vec.x = vec.x % (2*Math.PI);
					vec.y = vec.y % (2*Math.PI);
					vec.z = vec.z % (2*Math.PI);
				};
				
				var go = function( state, duration, cb, hold ) {
					var p = new Parallel(function() {
						aPrevState = currentState;
						aCurrentState = state;
						prevState = currentState;
						currentState = state;
						
						normalize( camera.rotation );
						
						if( cb ) {
							if( hold > 0 ) {
								window.setTimeout( cb, hold );
							}
							else {
								cb();
							}
						}
					});
					
					aPrevState = currentState;
					aCurrentState = state;
					
					var p0 = p.promise();
					var p1 = p.promise();
					
					new TWEEN.Tween( camera.position )
						.to(states[ state ][ "position" ], duration)
						.easing( TWEEN.Easing.Cubic.InOut )
						.onComplete( p0 )
						.start();
					
					var rotVec = getRotationVector( CameraInstance.rotation, states[ state ][ "rotation" ] );
					new TWEEN.Tween( CameraInstance.rotation )
						.to(rotVec, duration)
						.easing( TWEEN.Easing.Cubic.InOut )
						.onComplete( p1 )
						.start();
				};
				
				return {
					go			: go,
					current		: function() { return aCurrentState; },
					previous	: function() { return aPrevState;	},
					rotation	: function() { return states[ aCurrentState ].rotation; }
				};
			};
			
			var DiceController = function( dice ) {
				var faces = [
					{ x: 0, 			y: -Math.PI/2, 	z: 0 	},
					{ x: 0, 			y: Math.PI/2, 	z: 0 	},
					{ x: Math.PI/2, 	y: 0, 			z: 0 	},
					{ x: 1.5*Math.PI,	y: 0, 			z: 0 	},
					{ x: 0,				y: 0, 			z: 0 	},
					{ x: Math.PI,		y: 0, 			z: 0 	}
				];
				
				var animate = function( rand, cb ) {
					new TWEEN.Tween( dice.position )
						.to({ z: 500 }, 250)
						.easing( TWEEN.Easing.Cubic.InOut )
						.chain(
							new TWEEN.Tween( dice.rotation )
								.to( faces[ rand ], 250)
								.easing( TWEEN.Easing.Cubic.InOut ),
							new TWEEN.Tween( dice.position )
								.to({ z: 20 }, 250)
								.easing( TWEEN.Easing.Cubic.InOut )
								.onComplete( function() { if( cb ) cb( (rand + 1) ); } )
						)
						.start();
				};
				
				var roll = function( cb ) {
					var rand = Math.floor( (Math.random() * 5.99) );
					animate( rand, cb );
				};
				
				return {
					roll: roll
				};
			};
			
			var PieceController = function( piece ) {
				var currentPosition = 1;
				
				var getMeasures = function( frame ) {
					frame = ( frame % 24 === 0 ) ? 24 : frame % 24;
					var side = ( frame % 6 === 0 ) ? Math.floor( frame / 6 ) : Math.floor( frame / 6 ) + 1;
					var relPosition = (frame % 6 === 0) ? 6 : frame % 6;
					return { side: side, rel: relPosition };
				};
				
				var evalFrame = function( frame ) {
					var moveSize, axis, direction;
					var t = getMeasures( frame );
					var n = getMeasures( frame + 1 );
					
					if( t.rel === 1 || n.rel === 1 ) moveSize = 150;
					else moveSize = 130;
					
					if( t.side === 1 ) { axis = 0; 	direction = -1; 	}
					if( t.side === 2 ) { axis = 1; 	direction = 1; 		}
					if( t.side === 3 ) { axis = 0; 	direction = 1; 		}
					if( t.side === 4 ) { axis = 1; 	direction = -1;		}
					
					return { axis: axis, direction: direction, size: moveSize, CameraInstance: n.side };
				};
				
				var generateChain = function( obj, frame, steps, stepCb, doneCb ) {
					var movesDone = 0;
					
					var moveDone = function( p ) {
						movesDone++;
						
						if( stepCb )
							stepCb( p );
						
						if( movesDone === steps ) {
							if( doneCb ) {
								var f = ((frame + steps) % 24 === 0) ? 24 : (frame + steps) % 24;
								var passed = (frame + steps) > 24;
								doneCb( f, passed );
							}
						}
						else {
							var f = frame + movesDone;
							step( f,  obj ).start();
						}
					};
					
					var step = function( f, obj ) {
						var p = evalFrame( f );
						var vec = { z: obj.position.z };
						if( p.axis === 0 ) {
							vec.x = obj.position.x + ( p.direction * p.size );
							vec.y = obj.position.y;
						}
						if( p.axis === 1 ) {
							vec.y = obj.position.y + ( p.direction * p.size );
							vec.x = obj.position.x;
						}
						
						return new TWEEN.Tween( obj.position )
							.to( vec, 250 )
							.easing( TWEEN.Easing.Cubic.InOut )
							.onComplete( function() { moveDone( p ); } );
					};
					
					return step( frame, obj );
				};
				
				var move = function( steps, stepCb, doneCb ) {
					generateChain( piece, currentPosition, steps, stepCb, function( newPosition, passed ) {
						currentPosition = newPosition;
						doneCb( newPosition, passed );
					})
					.start();
				};
				
				return {
					move: move
				};
			};
			
			var RiskController = function() {
				
				var risks = {
					influenza		: { risk: 0, phImpact: 20, mhImpact: 20 },
					heartAttack		: { risk: 0, phImpact: 70, mhImpact: 70 },
					stroke			: { risk: 0, phImpact: 70, mhImpact: 70 },
					breastCancer	: { risk: 0, phImpact: 70, mhImpact: 70 },
					cysticFibrosis	: { risk: 0, phImpact: 30, mhImpact: 20 },
					lplu			: { risk: 0, phImpact: 20, mhImpact: 20 }
				};
				
				var generate = function() {
					var sum = 0;
					for( var k in risks ) {
						if( k !== "influenza" ) {
							var r = 0.1 + ( Math.random() * 0.1 );
							risks[ k ].lower = sum;
							sum = sum + r;
							risks[ k ].risk = r;
							risks[ k ].upper = sum;
						}
					}
					risks[ "influenza" ].risk = 1 - sum;
					risks[ "influenza" ].lower = sum;
					risks[ "influenza" ].upper = 1;
				};
				
				var getRandom = function() {
					var a = Math.random();
					for( var s in risks ) {
						if( a > risks[ s ].lower && a < risks[ s ].upper ) {
							return { 
								sickness: s, 
								risk: risks[ s ].risk, 
								phImpact: risks[ s ].phImpact, 
								mhImpact: risks[ s ].mhImpact
							};
						}
					}
				};
				
				generate();
				
				return {
					get			: function() { return risks; },
					getRandom	: getRandom
				};
			};
			
			var BoardController = function() {
			
				var boardStates = [
					{ // 1 
						type: "start"
					},
					{ // 2
						type: "free" 
					},
					{ // 3
						type: "free" 
					},
					{ // 4
						type: "free" 
					},
					{ // 5
						type: "sickness" 
					},
					{ // 6
						type: "exercise" 
					},
					{ // 7
						type: "seq" 
					},
					{ // 8
						type: "free" 
					},
					{ // 9
						type: "free" 
					},
					{ // 10
						type: "free" 
					},
					{ // 11
						type: "sickness" 
					},
					{ // 12
						type: "exercise" 
					},
					{ // 13
						type: "seq" 
					},
					{ // 14
						type: "free" 
					},
					{ // 15
						type: "free" 
					},
					{ // 16
						type: "free" 
					},
					{ // 17
						type: "sickness" 
					},
					{ // 18
						type: "exercise" 
					},
					{ // 19
						type: "seq" 
					},
					{ // 20
						type: "free" 
					},
					{ // 21
						type: "free" 
					},
					{ // 22
						type: "free" 
					},
					{ // 23
						type: "sickness" 
					},
					{ // 24
						type: "exercise" 
					}
				];
				
				var hit = function( frame, passed, doneCb ) {
					var hj = HealthJournalControllerInstance;
					
					console.log( hj.physicalHealth() );
					if( passed ) {
						hj.birthday();
					}
					
					var state = boardStates[ frame-1 ];
					if( state.type === "seq" ) {
						var r = RiskControllerInstance.getRandom();
						
						hj.risk( r.sickness, Math.round(r.risk * 100) );
						if( r.risk > 0.05 ) {
							hj.mentalHealth( -10, true );
						}
						
						hj.pay( 10000 );
					}
					else if( state.type === "sickness" ) {
						var r = RiskControllerInstance.getRandom();
						console.log( r );
						hj.physicalHealth( -r.phImpact, true );
						hj.mentalHealth( -r.mhImpact, true );
					}
					else if( state.type === "exercise" ) {
						hj.physicalHealth( 20, true );
						hj.mentalHealth( 20, true );
						hj.pay( 5000 );
					}
					
					doneCb();
				};
				
				return {
					hit: hit
				};
			};
			
			var CardController = function() {
				return {
					draw: function() {
						
					}
				};
			};
			
			var PlayerDetailsController = function( el, posVector ) {
				var visController = new VisibilityController( el, { opacity: 1 }, { opacity: 0 }, true );
				
				var place = function() {
					var screen = Utils.toScreenCoordinates( posVector );
					el.css({
						left	: screen.x - ( el.outerWidth( true ) / 2 ),
						top		: screen.y
					});
				};
				
				var show = function( cb ) {
					place();
					visController.show( 500, cb );
				};
				
				var hide = function( cb ) {
					visController.hide( 500, cb );
				};
				
				return {
					show	: show,
					hide	: hide,
					place	: place,
					el		: function() { return el; }
				};
			};
			
			var LetsRollController = function( el, obj ) {
				var visController = new VisibilityController( el, { opacity: 1 }, { opacity: 0 }, true );
				
				var show = function( rotation ) {
					obj.rotation.z = rotation;
					visController.show( 500 );
				};
				
				var hide = function() {
					visController.hide( 500 );
				};
				
				return {
					show: show,
					hide: hide
				};
			};
			
			var ClipBoardController = function( container, clipBoard ) {
				var visController = new VisibilityController( clipBoard, { left: "-20px" }, { left: "-311px" }, true );
				
				var show = function( cb ) {
					place();
					visController.show( 1000, cb );
				};
				
				var hide = function( cb ) {
					visController.hide( 1000, cb );
				};
				
				var place = function() {
					clipBoard.css({
						top			: (container.height() / 2) -
									  (clipBoard.outerHeight( true ) / 2),
						opacity		: 1
					});
				};
				
				return {
					show	: show,
					hide	: hide,
					place	: place
				};
			};
			
			var VisibilityController = function( el, onShow, onHide, initialHide ) {
				var show = function( duration, cb ) {
					el.animate(
						onShow,
						{
							duration: duration,
							complete: function() {
								if( cb ) cb();
							}
						}
					);
				};
				
				var hide = function( duration, cb ) {
					el.animate(
						onHide,
						{
							duration: duration,
							complete: function() {
								if( cb ) cb();
							}
						}
					);
				};
				
				if( initialHide )
					hide( 0 );
				
				return {
					show: show,
					hide: hide
				};
			};
			
			$(function() {
				var p = new Parallel(function() {
					Game.init();
					Game.start();
				});
				
				var p0 = p.promise();
				var p1 = p.promise();
				var p2 = p.promise();
				
				Textures.wood = THREE.ImageUtils.loadTexture("tex/teak.jpg", {}, p0);
				Textures.wood.wrapS = THREE.RepeatWrapping;
				Textures.wood.wrapT = THREE.RepeatWrapping;
				Textures.wood.repeat.set(10, 10);
				Textures.wood.needsUpdate = true;
				
				Textures.board = THREE.ImageUtils.loadTexture("tex/board.png", {}, p1);
				Textures.board.wrapS = THREE.RepeatWrapping;
				Textures.board.wrapT = THREE.RepeatWrapping;
				Textures.board.repeat.set(1, 1);
				Textures.board.needsUpdate = true;
				
				Textures.card = THREE.ImageUtils.loadTexture("tex/card.png", {}, p2);
				Textures.card.wrapS = THREE.RepeatWrapping;
				Textures.card.wrapT = THREE.RepeatWrapping;
				Textures.card.repeat.set(1, 1);
				Textures.card.needsUpdate = true;
				
				Textures.dice = [];
				for( var i = 0; i < 6; i++ ) {
					var cb = p.promise();
					Textures.dice[ i ] = THREE.ImageUtils.loadTexture("tex/dice" + (i+1) + ".png", {}, cb);
				}
				
				$(window).resize(function() {
					RendererInstance.setSize( $(window).width(), $(window).height() );
					CameraInstance.aspect = $(window).width() / $(window).height();
					CameraInstance.updateProjectionMatrix();
					
					ClipBoardControllerInstance.place();
					PlayerDetailsControllerInstance.place();
				});
				
				document.addEventListener( "mousedown", onDocumentMouseDown, false );
			});
		</script>
		<div class="playerDetails">
			<p>
				<input type="text" value="" class="name" placeholder="navn"/>
			</p>
			<p>
				<span>
					<input type="button" value="Mann" class="male">
					<input type="button" value="Kvinne" class="female">
				</span>
			</p>
		</div>
		
		<div class="clipBoard">
			<div class="healthJournal">
				<div class="header">
					<div class="colorBar"></div>
					<div class="headerText">
						<h1>helsejournal</h1>
						<h2 class="name">THOMAS ANDRESEN</h2>
					</div>
				</div>
				<div class="bio">
					<img class="picture" />
					<div class="bioInfo">
						<div class="line">
							<p class="key">KJØNN</p>
							<p class="val gender">mann</p>
						</div>
						<div class="line">
							<p class="key">ALDER</p>
							<p class="val age">25</p>
						</div>
						<div class="line">
							<p class="key">INNTEKT</p>
							<p class="val income">0</p>
						</div>
						<div class="line">
							<p class="key">FORMUE</p>
							<p class="val balance">0</p>
						</div>
					</div>
				</div>
				<div class="health">
					<div class="line">
						<p class="key">FYSISK HELSE</p>
						<p class="val">
							<div class="progressBar physical">
								<div class="perc">10%</div>
								<div class="bar"></div>
							</div>
						</p>
					</div>
					<div class="line">
						<p class="key">MENTAL HELSE</p>
						<p class="val">
							<div class="progressBar mental">
								<div class="perc">10%</div>
								<div class="bar"></div>
							</div>
						</p>
					</div>
				</div>
				<div class="risks">
					<p class="key">KARTLAGTE RISIKOER</p>
					<div class="diseases">
					</div>
				</div>
			</div>
		</div>
	
		<div class="letsRoll"></div>
	</body>
</html>